function MarkerClusterer(d,c,e){this.extend(MarkerClusterer,google.maps.OverlayView);this.map_=d;this.markers_=[];this.clusters_=[];this.sizes=[53,56,66,78,90];this.styles_=[];this.ready_=false;var a=e||{};this.gridSize_=a.gridSize||60;this.maxZoom_=a.maxZoom||null;this.styles_=a.styles||[];this.imagePath_=a.imagePath||this.MARKER_CLUSTER_IMAGE_PATH_;this.imageExtension_=a.imageExtension||this.MARKER_CLUSTER_IMAGE_EXTENSION_;this.zoomOnClick_=a.zoomOnClick||true;this.setupStyles_();this.setMap(d);this.prevZoom_=this.map_.getZoom();var b=this;google.maps.event.addListener(this.map_,"zoom_changed",function(){if(this.prevZoom_!=b.map_.getZoom()){this.prevZoom_=b.map_.getZoom();b.resetViewport()}});google.maps.event.addListener(this.map_,"bounds_changed",function(){b.redraw()});c&&c.length&&this.addMarkers(c,false)}MarkerClusterer.prototype.MARKER_CLUSTER_IMAGE_PATH_="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m";MarkerClusterer.prototype.MARKER_CLUSTER_IMAGE_EXTENSION_="png";MarkerClusterer.prototype.extend=function(a,b){return function(a){for(property in a.prototype)this.prototype[property]=a.prototype[property];return this}.apply(a,[b])};MarkerClusterer.prototype.onAdd=function(){this.setReady_(true)};MarkerClusterer.prototype.idle=function(){};MarkerClusterer.prototype.draw=function(){};MarkerClusterer.prototype.setupStyles_=function(){for(var b=0,a;a=this.sizes[b];b++)this.styles_.push({url:this.imagePath_+(b+1)+"."+this.imageExtension_,height:a,width:a})};MarkerClusterer.prototype.setStyles=function(a){this.styles_=a};MarkerClusterer.prototype.getStyles=function(){return this.styles_};MarkerClusterer.prototype.isZoomOnClick=function(){return this.zoomOnClick_};MarkerClusterer.prototype.getMarkers=function(){return this.markers_};MarkerClusterer.prototype.getTotalMarkers=function(){return this.markers_};MarkerClusterer.prototype.setMaxZoom=function(a){this.maxZoom_=a};MarkerClusterer.prototype.getMaxZoom=function(){return this.maxZoom_||this.map_.mapTypes[this.map_.getMapTypeId()].maxZoom};MarkerClusterer.prototype.calculator_=function(e,d){var a=0,c=e.length,b=c;while(b!==0){b=parseInt(b/10,10);a++}a=Math.min(a,d);return{text:c,index:a}};MarkerClusterer.prototype.setCalculator=function(a){this.calculator_=a};MarkerClusterer.prototype.getCalculator=function(){return this.calculator_};MarkerClusterer.prototype.addMarkers=function(d,c){for(var b=0,a;a=d[b];b++)this.pushMarkerTo_(a);!c&&this.redraw()};MarkerClusterer.prototype.pushMarkerTo_=function(a){a.setVisible(false);a.setMap(null);a.isAdded=false;if(a.draggable){var b=this;google.maps.event.addListener(a,"dragend",function(){a.isAdded=false;b.resetViewport();b.redraw()})}this.markers_.push(a)};MarkerClusterer.prototype.addMarker=function(b,a){this.pushMarkerTo_(b);!a&&this.redraw()};MarkerClusterer.prototype.removeMarkerBase_=function(a){var b=-1;if(this.markers_.indexOf)b=this.markers_.indexOf(a);else for(var c=0,d;d=this.markers_[c];c++)if(d==a){b=c;continue}if(b==-1)return false;this.markers_.splice(b,1);a.setVisible(false);a.setMap(null);return true};MarkerClusterer.prototype.removeMarker=function(b){var a=this.removeMarkerBase_(b);if(a){this.resetViewport();this.redraw();return true}else return false};MarkerClusterer.prototype.removeMarkers=function(c){for(var d=false,b=0,a;a=c[b];b++)this.removeMarkerBase_(a);this.resetViewport();this.redraw()};MarkerClusterer.prototype.setReady_=function(a){if(!this.ready_){this.ready_=a;this.createClusters_()}};MarkerClusterer.prototype.getTotalClusters=function(){return this.clusters_.length};MarkerClusterer.prototype.getMap=function(){return this.map_};MarkerClusterer.prototype.setMap=function(a){this.map_=a};MarkerClusterer.prototype.getGridSize=function(){return this.gridSize_};MarkerClusterer.prototype.setGridSize=function(a){this.gridSize_=a};MarkerClusterer.prototype.getExtendedBounds=function(a){var b=this.getProjection(),h=new google.maps.LatLng(a.getNorthEast().lat(),a.getNorthEast().lng()),e=new google.maps.LatLng(a.getSouthWest().lat(),a.getSouthWest().lng()),d=b.fromLatLngToDivPixel(h);d.x+=this.gridSize_;d.y-=this.gridSize_;var c=b.fromLatLngToDivPixel(e);c.x-=this.gridSize_;c.y+=this.gridSize_;var f=b.fromDivPixelToLatLng(d),g=b.fromDivPixelToLatLng(c);a.extend(f);a.extend(g);return a};MarkerClusterer.prototype.isMarkerInBounds_=function(b,a){return a.contains(b.getPosition())};MarkerClusterer.prototype.clearMarkers=function(){this.resetViewport();this.markers_=[]};MarkerClusterer.prototype.resetViewport=function(){for(var b=0,c;c=this.clusters_[b];b++)c.remove();for(var b=0,a;a=this.markers_[b];b++){a.isAdded=false;a.setMap(null);a.setVisible(false)}this.clusters_=[]};MarkerClusterer.prototype.redraw=function(){this.createClusters_()};MarkerClusterer.prototype.createClusters_=function(){if(!this.ready_)return;for(var f=new google.maps.LatLngBounds(this.map_.getBounds().getSouthWest(),this.map_.getBounds().getNorthEast()),g=this.getExtendedBounds(f),d=0,b;b=this.markers_[d];d++){var c=false;if(!b.isAdded&&this.isMarkerInBounds_(b,g)){for(var e=0,a;a=this.clusters_[e];e++)if(!c&&a.getCenter()&&a.isMarkerInClusterBounds(b)){c=true;a.addMarker(b);break}if(!c){var a=new Cluster(this);a.addMarker(b);this.clusters_.push(a)}}}};function Cluster(a){this.markerClusterer_=a;this.map_=a.getMap();this.gridSize_=a.getGridSize();this.center_=null;this.markers_=[];this.bounds_=null;this.clusterIcon_=new ClusterIcon(this,a.getStyles(),a.getGridSize())}Cluster.prototype.isMarkerAlreadyAdded=function(a){if(this.markers_.indexOf)return this.markers_.indexOf(a)!=-1;else for(var b=0,c;c=this.markers_[b];b++)if(c==a)return true;return false};Cluster.prototype.addMarker=function(a){if(this.isMarkerAlreadyAdded(a))return false;if(!this.center_){this.center_=a.getPosition();this.calculateBounds_()}if(this.markers_.length==0){a.setMap(this.map_);a.setVisible(true)}else if(this.markers_.length==1){this.markers_[0].setMap(null);this.markers_[0].setVisible(false)}a.isAdded=true;this.markers_.push(a);this.updateIcon();return true};Cluster.prototype.getMarkerClusterer=function(){return this.markerClusterer_};Cluster.prototype.getBounds=function(){this.calculateBounds_();return this.bounds_};Cluster.prototype.remove=function(){this.clusterIcon_.remove();delete this.markers_};Cluster.prototype.getCenter=function(){return this.center_};Cluster.prototype.calculateBounds_=function(){var a=new google.maps.LatLngBounds(this.center_,this.center_);this.bounds_=this.markerClusterer_.getExtendedBounds(a)};Cluster.prototype.isMarkerInClusterBounds=function(a){return this.bounds_.contains(a.getPosition())};Cluster.prototype.getMap=function(){return this.map_};Cluster.prototype.updateIcon=function(){var e=this.map_.getZoom(),f=this.markerClusterer_.getMaxZoom();if(e>f){for(var b=0,a;a=this.markers_[b];b++){a.setMap(this.map_);a.setVisible(true)}return}if(this.markers_.length<2){this.clusterIcon_.hide();return}var c=this.markerClusterer_.getStyles().length,d=this.markerClusterer_.getCalculator()(this.markers_,c);this.clusterIcon_.setCenter(this.center_);this.clusterIcon_.setSums(d);this.clusterIcon_.show()};function ClusterIcon(a,c,b){a.getMarkerClusterer().extend(ClusterIcon,google.maps.OverlayView);this.styles_=c;this.padding_=b||0;this.cluster_=a;this.center_=null;this.map_=a.getMap();this.div_=null;this.sums_=null;this.visible_=false;this.setMap(this.map_)}ClusterIcon.prototype.triggerClusterClick=function(){var a=this.cluster_.getMarkerClusterer();google.maps.event.trigger(a,"clusterclick",[this.cluster_]);if(a.isZoomOnClick()){this.map_.panTo(this.cluster_.getCenter());this.map_.fitBounds(this.cluster_.getBounds())}};ClusterIcon.prototype.onAdd=function(){this.div_=document.createElement("DIV");if(this.visible_){var c=this.getPosFromLatLng_(this.center_);this.div_.style.cssText=this.createCss(c);this.div_.innerHTML=this.sums_.text}var a=this.getPanes();a.overlayImage.appendChild(this.div_);var b=this;google.maps.event.addDomListener(this.div_,"click",function(){b.triggerClusterClick()})};ClusterIcon.prototype.getPosFromLatLng_=function(b){var a=this.getProjection().fromLatLngToDivPixel(b);a.x-=parseInt(this.width_/2,10);a.y-=parseInt(this.height_/2,10);return a};ClusterIcon.prototype.draw=function(){if(this.visible_){var a=this.getPosFromLatLng_(this.center_);this.div_.style.top=a.y+"px";this.div_.style.left=a.x+"px"}};ClusterIcon.prototype.hide=function(){if(this.div_)this.div_.style.display="none";this.visible_=false};ClusterIcon.prototype.show=function(){if(this.div_){var a=this.getPosFromLatLng_(this.center_);this.div_.style.cssText=this.createCss(a);this.div_.style.display=""}this.visible_=true};ClusterIcon.prototype.remove=function(){this.setMap(null)};ClusterIcon.prototype.onRemove=function(){if(this.div_&&this.div_.parentNode){this.hide();this.div_.parentNode.removeChild(this.div_);this.div_=null}};ClusterIcon.prototype.setSums=function(a){this.sums_=a;this.text_=a.text;this.index_=a.index;if(this.div_)this.div_.innerHTML=a.text;this.useStyle()};ClusterIcon.prototype.useStyle=function(){var b=Math.max(0,this.sums_.index-1);b=Math.min(this.styles_.length-1,b);var a=this.styles_[b];this.url_=a.url;this.height_=a.height;this.width_=a.width;this.textColor_=a.opt_textColor;this.anchor=a.opt_anchor;this.textSize_=a.opt_textSize};ClusterIcon.prototype.setCenter=function(a){this.center_=a};ClusterIcon.prototype.createCss=function(b){var a=[];if(document.all)a.push('filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale,src="'+this.url_+'");');else a.push("background:url("+this.url_+");");if(typeof this.anchor_==="object"){if(typeof this.anchor_[0]==="number"&&this.anchor_[0]>0&&this.anchor_[0]<this.height_)a.push("height:"+(this.height_-this.anchor_[0])+"px; padding-top:"+this.anchor_[0]+"px;");else a.push("height:"+this.height_+"px; line-height:"+this.height_+"px;");if(typeof this.anchor_[1]==="number"&&this.anchor_[1]>0&&this.anchor_[1]<this.width_)a.push("width:"+(this.width_-this.anchor_[1])+"px; padding-left:"+this.anchor_[1]+"px;");else a.push("width:"+this.width_+"px; text-align:center;")}else a.push("height:"+this.height_+"px; line-height:"+this.height_+"px; width:"+this.width_+"px; text-align:center;");var c=this.textColor_?this.textColor_:"black",d=this.textSize_?this.textSize_:11;a.push("cursor:pointer; top:"+b.y+"px; left:"+b.x+"px; color:"+c+"; position:absolute; font-size:"+d+"px; font-family:Arial,sans-serif; font-weight:bold");return a.join("")};window.MarkerClusterer=MarkerClusterer;MarkerClusterer.prototype.addMarker=MarkerClusterer.prototype.addMarker;MarkerClusterer.prototype.addMarkers=MarkerClusterer.prototype.addMarkers;MarkerClusterer.prototype.clearMarkers=MarkerClusterer.prototype.clearMarkers;MarkerClusterer.prototype.getCalculator=MarkerClusterer.prototype.getCalculator;MarkerClusterer.prototype.getGridSize=MarkerClusterer.prototype.getGridSize;MarkerClusterer.prototype.getMap=MarkerClusterer.prototype.getMap;MarkerClusterer.prototype.getMarkers=MarkerClusterer.prototype.getMarkers;MarkerClusterer.prototype.getMaxZoom=MarkerClusterer.prototype.getMaxZoom;MarkerClusterer.prototype.getStyles=MarkerClusterer.prototype.getStyles;MarkerClusterer.prototype.getTotalClusters=MarkerClusterer.prototype.getTotalClusters;MarkerClusterer.prototype.getTotalMarkers=MarkerClusterer.prototype.getTotalMarkers;MarkerClusterer.prototype.redraw=MarkerClusterer.prototype.redraw;MarkerClusterer.prototype.removeMarker=MarkerClusterer.prototype.removeMarker;MarkerClusterer.prototype.resetViewport=MarkerClusterer.prototype.resetViewport;MarkerClusterer.prototype.setCalculator=MarkerClusterer.prototype.setCalculator;MarkerClusterer.prototype.setGridSize=MarkerClusterer.prototype.setGridSize;MarkerClusterer.prototype.onAdd=MarkerClusterer.prototype.onAdd;MarkerClusterer.prototype.draw=MarkerClusterer.prototype.draw;MarkerClusterer.prototype.idle=MarkerClusterer.prototype.idle;ClusterIcon.prototype.onAdd=ClusterIcon.prototype.onAdd;ClusterIcon.prototype.draw=ClusterIcon.prototype.draw;ClusterIcon.prototype.onRemove=ClusterIcon.prototype.onRemove;(function(){var g=this,t=g._,k=typeof StopIteration!=="undefined"?StopIteration:"__break__",u=function(a){return a.replace(/([.*+?^${}()|[\]\/\\])/g,"\\$1")},c=Array.prototype,e=Object.prototype,h=c.slice,v=c.unshift,w=e.toString,i=e.hasOwnProperty,l=c.forEach,m=c.map,n=c.reduce,o=c.reduceRight,p=c.filter,q=c.every,r=c.some,f=c.indexOf,s=c.lastIndexOf;e=Array.isArray;var x=Object.keys,a=function(a){return new d(a)};if(typeof exports!=="undefined")exports._=a;g._=a;a.VERSION="1.0.2";var b=a.forEach=function(b,d,e){try{if(l&&b.forEach===l)b.forEach(d,e);else if(a.isNumber(b.length))for(var c=0,f=b.length;c<f;c++)d.call(e,b[c],c,b);else for(c in b)i.call(b,c)&&d.call(e,b[c],c,b)}catch(g){if(g!=k)throw g;}return b};a.map=function(a,c,d){if(m&&a.map===m)return a.map(c,d);var e=[];b(a,function(a,b,f){e.push(c.call(d,a,b,f))});return e};a.reduce=function(d,c,e,f){if(n&&d.reduce===n)return d.reduce(a.bind(e,f),c);b(d,function(a,b,d){c=e.call(f,c,a,b,d)});return c};a.reduceRight=function(b,c,d,e){if(o&&b.reduceRight===o)return b.reduceRight(a.bind(d,e),c);b=a.clone(a.toArray(b)).reverse();return a.reduce(b,c,d,e)};a.detect=function(d,e,f){var c;b(d,function(b,d,g){if(e.call(f,b,d,g)){c=b;a.breakLoop()}});return c};a.filter=function(a,c,d){if(p&&a.filter===p)return a.filter(c,d);var e=[];b(a,function(a,b,f){c.call(d,a,b,f)&&e.push(a)});return e};a.reject=function(c,d,e){var a=[];b(c,function(b,c,f){!d.call(e,b,c,f)&&a.push(b)});return a};a.every=function(d,c,f){c=c||a.identity;if(q&&d.every===q)return d.every(c,f);var e=true;b(d,function(b,d,g){(e=e&&c.call(f,b,d,g))||a.breakLoop()});return e};a.some=function(d,c,e){c=c||a.identity;if(r&&d.some===r)return d.some(c,e);var f=false;b(d,function(b,d,g){(f=c.call(e,b,d,g))&&a.breakLoop()});return f};a.include=function(c,d){if(f&&c.indexOf===f)return c.indexOf(d)!=-1;var e=false;b(c,function(b){(e=b===d)&&a.breakLoop()});return e};a.invoke=function(c,b){var d=a.rest(arguments,2);return a.map(c,function(a){return(b?a[b]:a).apply(a,d)})};a.pluck=function(b,c){return a.map(b,function(a){return a[c]})};a.max=function(c,d,f){if(!d&&a.isArray(c))return Math.max.apply(Math,c);var e={computed:-Infinity};b(c,function(b,a,c){a=d?d.call(f,b,a,c):b;a>=e.computed&&(e={value:b,computed:a})});return e.value};a.min=function(c,d,f){if(!d&&a.isArray(c))return Math.min.apply(Math,c);var e={computed:Infinity};b(c,function(b,a,c){a=d?d.call(f,b,a,c):b;a<e.computed&&(e={value:b,computed:a})});return e.value};a.sortBy=function(b,c,d){return a.pluck(a.map(b,function(a,b,e){return{value:a,criteria:c.call(d,a,b,e)}}).sort(function(a,b){a=a.criteria;b=b.criteria;return a<b?-1:a>b?1:0}),"value")};a.sortedIndex=function(f,g,b){b=b||a.identity;for(var c=0,d=f.length;c<d;){var e=c+d>>1;b(f[e])<b(g)?c=e+1:d=e}return c};a.toArray=function(b){return!b?[]:b.toArray?b.toArray():a.isArray(b)?b:a.isArguments(b)?h.call(b):a.values(b)};a.size=function(b){return a.toArray(b).length};a.first=function(a,b,c){return b&&!c?h.call(a,0,b):a[0]};a.rest=function(c,b,d){return h.call(c,a.isUndefined(b)||d?1:b)};a.last=function(a){return a[a.length-1]};a.compact=function(b){return a.filter(b,function(a){return!!a})};a.flatten=function(b){return a.reduce(b,[],function(b,c){if(a.isArray(c))return b.concat(a.flatten(c));b.push(c);return b})};a.without=function(b){var c=a.rest(arguments);return a.filter(b,function(b){return!a.include(c,b)})};a.uniq=function(b,c){return a.reduce(b,[],function(b,d,e){(0==e||(c===true?a.last(b)!=d:!a.include(b,d)))&&b.push(d);return b})};a.intersect=function(b){var c=a.rest(arguments);return a.filter(a.uniq(b),function(b){return a.every(c,function(c){return a.indexOf(c,b)>=0})})};a.zip=function(){for(var c=a.toArray(arguments),d=a.max(a.pluck(c,"length")),e=new Array(d),b=0;b<d;b++)e[b]=a.pluck(c,String(b));return e};a.indexOf=function(a,c){if(f&&a.indexOf===f)return a.indexOf(c);for(var b=0,d=a.length;b<d;b++)if(a[b]===c)return b;return-1};a.lastIndexOf=function(a,c){if(s&&a.lastIndexOf===s)return a.lastIndexOf(c);for(var b=a.length;b--;)if(a[b]===c)return b;return-1};a.range=function(f,d,e){var b=a.toArray(arguments),c=b.length<=1;f=c?0:b[0];d=c?b[0]:b[1];e=b[2]||1;b=Math.ceil((d-f)/e);if(b<=0)return[];b=new Array(b);c=f;for(var g=0;true;c+=e){if((e>0?c-d:d-c)>=0)return b;b[g++]=c}};a.bind=function(b,c){var d=a.rest(arguments,2);return function(){return b.apply(c||{},d.concat(a.toArray(arguments)))}};a.bindAll=function(c){var d=a.rest(arguments);if(d.length==0)d=a.functions(c);b(d,function(b){c[b]=a.bind(c[b],c)});return c};a.delay=function(b,c){var d=a.rest(arguments,2);return setTimeout(function(){return b.apply(b,d)},c)};a.defer=function(b){return a.delay.apply(a,[b,1].concat(a.rest(arguments)))};a.wrap=function(c,b){return function(){var d=[c].concat(a.toArray(arguments));return b.apply(b,d)}};a.compose=function(){var b=a.toArray(arguments);return function(){for(var c=a.toArray(arguments),d=b.length-1;d>=0;d--)c=[b[d].apply(this,c)];return c[0]}};a.keys=x||function(b){if(a.isArray(b))return a.range(0,b.length);var c=[];for(var d in b)i.call(b,d)&&c.push(d);return c};a.values=function(b){return a.map(b,a.identity)};a.functions=function(b){return a.filter(a.keys(b),function(c){return a.isFunction(b[c])}).sort()};a.extend=function(c){b(a.rest(arguments),function(a){for(var b in a)c[b]=a[b]});return c};a.clone=function(b){return a.isArray(b)?b.slice(0):a.extend({},b)};a.tap=function(a,b){b(a);return a};a.isEqual=function(b,c){if(b===c)return true;var d=typeof b;if(d!=typeof c)return false;if(b==c)return true;if(!b&&c||b&&!c)return false;if(b.isEqual)return b.isEqual(c);if(a.isDate(b)&&a.isDate(c))return b.getTime()===c.getTime();if(a.isNaN(b)&&a.isNaN(c))return true;if(a.isRegExp(b)&&a.isRegExp(c))return b.source===c.source&&b.global===c.global&&b.ignoreCase===c.ignoreCase&&b.multiline===c.multiline;if(d!=="object")return false;if(b.length&&b.length!==c.length)return false;d=a.keys(b);var f=a.keys(c);if(d.length!=f.length)return false;for(var e in b)if(!(e in c)||!a.isEqual(b[e],c[e]))return false;return true};a.isEmpty=function(b){if(a.isArray(b))return b.length===0;for(var c in b)if(i.call(b,c))return false;return true};a.isElement=function(a){return!!(a&&a.nodeType==1)};a.isArray=e||function(a){return!!(a&&a.concat&&a.unshift&&!a.callee)};a.isArguments=function(a){return a&&a.callee};a.isFunction=function(a){return!!(a&&a.constructor&&a.call&&a.apply)};a.isString=function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)};a.isNumber=function(a){return a===+a||w.call(a)==="[object Number]"};a.isBoolean=function(a){return a===true||a===false};a.isDate=function(a){return!!(a&&a.getTimezoneOffset&&a.setUTCFullYear)};a.isRegExp=function(a){return!!(a&&a.test&&a.exec&&(a.ignoreCase||a.ignoreCase===false))};a.isNaN=function(b){return a.isNumber(b)&&isNaN(b)};a.isNull=function(a){return a===null};a.isUndefined=function(a){return typeof a=="undefined"};a.noConflict=function(){g._=t;return this};a.identity=function(a){return a};a.times=function(b,c,d){for(var a=0;a<b;a++)c.call(d,a)};a.breakLoop=function(){throw k;};a.mixin=function(c){b(a.functions(c),function(b){y(b,a[b]=c[b])})};var z=0;a.uniqueId=function(a){var b=z++;return a?a+b:b};a.templateSettings={start:"<%",end:"%>",interpolate:/<%=(.+?)%>/g};a.template=function(c,d){var b=a.templateSettings,e=new RegExp("'(?=[^"+b.end.substr(0,1)+"]*"+u(b.end)+")","g");c=new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+c.replace(/[\r\t\n]/g," ").replace(e,"\t").split("'").join("\\'").split("\t").join("'").replace(b.interpolate,"',$1,'").split(b.start).join("');").split(b.end).join("p.push('")+"');}return p.join('');");return d?c(d):c};a.each=a.forEach;a.foldl=a.inject=a.reduce;a.foldr=a.reduceRight;a.select=a.filter;a.all=a.every;a.any=a.some;a.head=a.first;a.tail=a.rest;a.methods=a.functions;var d=function(a){this._wrapped=a},j=function(b,c){return c?a(b).chain():b},y=function(b,c){d.prototype[b]=function(){var b=a.toArray(arguments);v.call(b,this._wrapped);return j(c.apply(a,b),this._chain)}};a.mixin(a);b(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=c[a];d.prototype[a]=function(){b.apply(this._wrapped,arguments);return j(this._wrapped,this._chain)}});b(["concat","join","slice"],function(a){var b=c[a];d.prototype[a]=function(){return j(b.apply(this._wrapped,arguments),this._chain)}});d.prototype.chain=function(){this._chain=true;return this};d.prototype.value=function(){return this._wrapped}})();jQuery.fn.selectToUISlider=function(i){var d=jQuery(this),a=jQuery.extend({labels:3,tooltip:true,tooltipSrc:"text",labelSrc:"value",sliderOptions:null},i),m=function(){var a=[];d.each(function(){a.push("handle_"+jQuery(this).attr("id"))});return a}(),c=function(){var a=[];d.eq(0).find("option").each(function(){a.push({value:jQuery(this).attr("value"),text:jQuery(this).text()})});return a}(),e=function(){if(d.eq(0).find("optgroup").size()>0){var a=[];d.eq(0).find("optgroup").each(function(b){a[b]={};a[b].label=jQuery(this).attr("label");a[b].options=[];jQuery(this).find("option").each(function(){a[b].options.push({text:jQuery(this).text(),value:jQuery(this).attr("value")})})});return a}else return null}();function p(a){return a.constructor==Array}function g(b){return a.tooltipSrc=="text"?c[b].text:c[b].value}var l={step:1,min:0,orientation:"horizontal",max:c.length-1,range:d.length>1,slide:function(e,a){var b=jQuery(a.handle),c=g(a.value);b.attr("aria-valuetext",c).attr("aria-valuenow",a.value).find(".ui-slider-tooltip .ttContent").text(c);var d=jQuery("#"+b.attr("id").split("handle_")[1]);d.find("option").eq(a.value).attr("selected","selected")},values:function(){var a=[];d.each(function(){a.push(jQuery(this).get(0).selectedIndex)});return a}()};a.sliderOptions=i?jQuery.extend(l,i.sliderOptions):l;d.bind("change keyup click",function(){var c=jQuery(this).get(0).selectedIndex,a=jQuery("#handle_"+jQuery(this).attr("id")),b=a.data("handleNum");a.parents(".ui-slider:eq(0)").slider("values",b,c)});var b=jQuery("<div></div>");d.each(function(c){var e="",d=jQuery("label[for="+jQuery(this).attr("id")+"]"),h=d.size()>0?"Slider control for "+d.text()+"":"",f=d.attr("id")||d.attr("id","label_"+m[c]).attr("id");if(a.tooltip==false)e=' style="display: none;"';jQuery('<a href="#" tabindex="0" id="'+m[c]+'" class="ui-slider-handle" role="slider" aria-labelledby="'+f+'" aria-valuemin="'+a.sliderOptions.min+'" aria-valuemax="'+a.sliderOptions.max+'" aria-valuenow="'+a.sliderOptions.values[c]+'" aria-valuetext="'+g(a.sliderOptions.values[c])+'" ><span class="screenReaderContext">'+h+'</span><span class="ui-slider-tooltip ui-widget-content ui-corner-all"'+e+'><span class="ttContent"></span><span class="ui-tooltip-pointer-down ui-widget-content"><span class="ui-tooltip-pointer-down-inner"></span></span></span></a>').data("handleNum",c).appendTo(b)});if(e){var h=0,k=b.append('<dl class="ui-slider-scale ui-helper-reset" role="presentation"></dl>').find(".ui-slider-scale:eq(0)");jQuery(e).each(function(d){k.append('<dt style="width: '+(100/e.length).toFixed(2)+"%; left:"+(d/(e.length-1)*100).toFixed(2)+'%"><span>'+this.label+"</span></dt>");var b=this.options;jQuery(this.options).each(function(d){var f=h==c.length-1||h==0?'style="display: none;"':"",e=a.labelSrc=="text"?b[d].text:b[d].value;k.append('<dd style="left:'+n(h)+'"><span class="ui-slider-label">'+e+'</span><span class="ui-slider-tic ui-widget-content"'+f+"></span></dd>");h++})})}else{var k=b.append('<ol class="ui-slider-scale ui-helper-reset" role="presentation"></ol>').find(".ui-slider-scale:eq(0)");jQuery(c).each(function(b){var e=b==c.length-1||b==0?'style="display: none;"':"",d=a.labelSrc=="text"?this.text:this.value;k.append('<li style="left:'+n(b)+'"><span class="ui-slider-label">'+d+'</span><span class="ui-slider-tic ui-widget-content"'+e+"></span></li>")})}function n(a){return(a/(c.length-1)*100).toFixed(2)+"%"}a.labels>1&&b.find(".ui-slider-scale li:last span.ui-slider-label, .ui-slider-scale dd:last span.ui-slider-label").addClass("ui-slider-label-show");for(var o=Math.max(1,Math.round(c.length/a.labels)),f=0;f<c.length;f+=o)c.length-f>o&&b.find(".ui-slider-scale li:eq("+f+") span.ui-slider-label, .ui-slider-scale dd:eq("+f+") span.ui-slider-label").addClass("ui-slider-label-show");b.find(".ui-slider-scale dt").each(function(a){jQuery(this).css({left:(100/e.length*a).toFixed(2)+"%"})});b.insertAfter(jQuery(this).eq(this.length-1)).slider(a.sliderOptions).attr("role","application").find(".ui-slider-label").each(function(){jQuery(this).css("marginLeft",-jQuery(this).width()/2)});b.find(".ui-tooltip-pointer-down-inner").each(function(){var b=jQuery(".ui-tooltip-pointer-down-inner").css("borderTopWidth"),a=jQuery(this).parents(".ui-slider-tooltip").css("backgroundColor");jQuery(this).css("border-top",b+" solid "+a)});var j=b.slider("values");if(p(j))jQuery(j).each(function(a){b.find(".ui-slider-tooltip .ttContent").eq(a).text(g(this))});else b.find(".ui-slider-tooltip .ttContent").eq(0).text(g(j));return this};var _tmplCache={};this.parseTemplate=function(a,e){var c="";a=a.replace("<![CDATA[","");a=a.replace("]\]>","");try{var b=_tmplCache[a];if(!b){var d="var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+a.replace(/[\r\t\n]/g," ").replace(/'(?=[^#]*#>)/g,"\t").split("'").join("\\'").split("\t").join("'").replace(/<#=(.+?)#>/g,"',$1,'").split("<#").join("');").split("#>").join("p.push('")+"');}return p.join('');";b=new Function("obj",d);_tmplCache[a]=b}return b(e)}catch(f){c=f.message}return"< # ERROR: "+c.htmlEncode()+" # >"};var map=null,cluster=null,eventids=[],coder=null,iconurlstart="/Content/icons",currenrequest=null;google.maps.Map.prototype.currentOpenWindow=null;google.maps.Map.prototype.cluster=null;google.maps.Map.prototype.openInfoWindow=function(b,a){this.currentOpenWindow&&this.currentOpenWindow.close();this.currentOpenWindow=b;this.currentOpenWindow&&a&&this.currentOpenWindow.open(this,a)};google.maps.Map.prototype.addMarker=function(e,b,c,d,f){if(_.indexOf(eventids,b)===-1){eventids.push(b);var a=new google.maps.Marker({position:e,icon:iconurlstart+"/"+d+".png",zIndex:f});a.event={id:b,catid:c};cluster.addMarker(a);return a}};google.maps.Map.prototype.clearOutSideMarkers=function(){var b=map.getBounds(),a=_.select(cluster.getMarkers(),function(a){if(b.contains(a.getPosition())===false){var c=_.indexOf(eventids,a.event.id);eventids.splice(c,1);return a}});cluster.removeMarkers(a)};$.extend({getUrlVars:function(){for(var b=[],a,d=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),c=0;c<d.length;c++){a=d[c].split("=");b.push(a[0]);b[a[0]]=a[1]}return b},getUrlVar:function(a){return $.getUrlVars()[a]}});function GetIconUrl(a){return iconurlstart+"/"+GetIconName(a)+".png"}function GetIconName(a){switch(a){case 2:return"thefth";case 8:case 9:return"crimescene";case 11:return"rape";case 13:return"gun";case 14:return"revolution";case 5:return"fire";case 4:return"icyroad";case 3:return"bank";default:return"accident"}}function refresh(){var d=map.getBounds(),f=d.getNorthEast(),g=d.getSouthWest(),a,b,c;switch($("input[name=datemode]:checked").val()){case"day":a="day";break;case"week":a="week";break;case"month":a="month";b=getDateFromSelect("start");c=getDateFromSelect("end");break;default:return}var e="";e=$.getUrlVar("race");var h=_.reduce($(".cat:checked"),"",function(a,b){return a+"-"+b.id});currenrequest=$.post("/data",{categories:h,ne_lat:f.lat(),ne_lng:f.lng(),sw_lat:g.lat(),sw_lng:g.lng(),datemode:a,startdate:b,enddate:c,race:e},function(a){if(a.count>=2e3){alert("For mange punkter, zoom ind eller vælg smallere dato-interval");return}map.clearOutSideMarkers();_.each(a.events,function(b){var c=new google.maps.LatLng(b[0],b[1]);if(b[2].length>1){var a=map.addMarker(c,b[2][0][0],b[2][0][1],"police2",1);if(a){var d=b[2].slice();google.maps.event.addListener(a,"click",function(){if(a.infoWindowCached)map.openInfoWindow(a.infoWindowCached,a);else $.post("/eventdatamulti",{eventidstring:_.reduce(d,"",function(a,b){return a+"-"+b[0]})},function(c){var b=new google.maps.InfoWindow({content:_.reduce(c,"",function(b,a){a.url=baseurl+a.url;a.iconUrl=GetIconUrl(a.catid);a.escapedUrl=escape(a.url);a.escapedTitle=escape(a.title);return b+parseTemplate($("#infoWindowContentTemplateIcon").html(),a)})});a.infoWindowCached=b;map.openInfoWindow(a.infoWindowCached,a)})});if(currentevent&&currentevent.eventid===a.event.id){google.maps.event.trigger(a,"click");currentevent=null}}b[2].shift();_(b[2]).chain().each(function(b){if(currentevent&&currentevent.eventid===b[0]){google.maps.event.trigger(a,"click");currentevent=null}map.addMarker(c,b[0],b[1],"1x1",-1)})}else{var a=map.addMarker(c,b[2][0][0],b[2][0][1],GetIconName(b[2][0][1]),1);a&&google.maps.event.addListener(a,"click",function(){if(a.infoWindowCached)map.openInfoWindow(a.infoWindowCached,a);else $.post("/eventdata",{eventid:a.event.id},function(b){b.url=baseurl+b.url;b.escapedUrl=escape(b.url);b.escapedTitle=escape(b.title);var c=new google.maps.InfoWindow({content:parseTemplate($("#infoWindowContentTemplate").html(),b)});map.openInfoWindow(c,a);a.infoWindowCached=c})});if(currentevent&&currentevent.eventid===a.event.id){google.maps.event.trigger(a,"click");currentevent=null}}})},"json")}function getDateFromSelect(b){var a=$("#"+b+" option:selected");return a.attr("value")+"-"+a.parent().attr("label")}$(function(){$.browser.msie&&$("input[value='month']").click(function(a){a.preventDefault();alert("Internet Explorer kan ikke vises mange punkter, skift browser.");$("input[value='week']").attr("checked",true);a.preventDefault();return});_.each($(".cat"),function(a){$(a).attr("checked","checked")});if(currentevent){$("#start optgroup[label='"+currentevent.year+"'] option[value='"+currentevent.month+"']").attr("selected","selected").index();$("#end optgroup[label='"+currentevent.nextmonthyear+"'] option[value='"+currentevent.nextmonth+"']").attr("selected","selected").index();$("input[value=month]:radio").attr("checked","checked")}else{var a=$("select#start option").length;$("#start option").eq(a-2).attr("selected","selected");$("#end option").eq(a-1).attr("selected","selected")}if(currentevent)var d=new google.maps.LatLng(currentevent.lat,currentevent.lng),e=15;else var d=new google.maps.LatLng(56.084297562061408,10.9423828125),e=7;var b={zoom:e,center:d,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(document.getElementById("map_canvas"),b);if(!currentevent){var f=new google.maps.LatLng(57.8355660225202,1.5325698028125e1),g=new google.maps.LatLng(54.549315415656871,7.8769675593749788),c=new google.maps.LatLngBounds(g,f);map.fitBounds(c)}cluster=new MarkerClusterer(map,[],{maxZoom:14});google.maps.event.addListener(map,"idle",function(){refresh()});google.maps.event.addListener(map,"bounds_changed",function(){currenrequest&&currenrequest.abort()});$(".cat").change(function(){if($(this).is(":checked"))refresh();else{var b=parseInt($(this).attr("id")),a=_.select(cluster.getMarkers(),function(a){if(a.event.catid===b){var c=_.indexOf(eventids,a.event.id);eventids.splice(c,1);return a}});cluster.removeMarkers(a)}});$("#selectall").click(function(a){a.preventDefault();$(".cat").attr("checked",true);refresh()});$("#deselectall").click(function(a){a.preventDefault();$(".cat").attr("checked",false);cluster.clearMarkers();eventids=[]});$("select").selectToUISlider({labels:12,sliderOptions:{change:function(){cluster.clearMarkers();eventids=[];refresh()}}}).hide();$("input[value=day]:radio").change(function(){if($(this).attr("checked")){$("#dateslider").hide();cluster.clearMarkers();eventids=[];refresh()}});$("input[value=week]:radio").change(function(){if($(this).attr("checked")){$("#dateslider").hide();cluster.clearMarkers();eventids=[];refresh()}});$("input[value=month]:radio").change(function(){if($.browser.msie)return;if($(this).attr("checked")){$("#dateslider").show();cluster.clearMarkers();eventids=[];refresh()}});if($("input[name=datemode]:checked").val()=="month")$("#dateslider").show();else $("#dateslider").hide();$("#tipdialog").dialog({autoOpen:false,modal:true,buttons:{},resizable:false});$("#closedialog").click(function(a){a.preventDefault();$("#tipdialog").dialog("close")});$("a.tip").live("click",function(a){a.preventDefault();$("#eventcode").html($(this).parent().attr("id"));$("#tipdialog").dialog("open")})});function switchBlock(c,b){var a=document.getElementById(c);if(a.style.display=="none")a.style.display="block";else if(a.style.display=="block")a.style.display="none";else if(b===0)a.style.display="none";else a.style.display="block"}